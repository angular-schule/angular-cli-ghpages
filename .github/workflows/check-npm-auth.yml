name: Check NPM Publishing (Trusted Publishers)

on:
  workflow_dispatch:

# Required for OIDC token exchange with npm
permissions:
  contents: read
  id-token: write

jobs:
  test-publish:
    runs-on: ubuntu-latest
    environment: npm-publish

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'

      - name: Build package
        working-directory: src
        run: |
          echo "üì¶ Building package..."
          npm ci
          npm run build

      - name: Test publish with provenance (dry-run)
        working-directory: src/dist
        run: |
          echo "üîê Testing Trusted Publishers + Provenance (dry-run)..."
          echo "---"
          echo "This will:"
          echo "  1. Request OIDC token from GitHub"
          echo "  2. Exchange it with npm for temporary credentials"
          echo "  3. Generate provenance attestation"
          echo "  4. Simulate publish (without actually publishing)"
          echo "---"

          if npm publish --provenance --dry-run; then
            echo "---"
            echo "‚úÖ Trusted Publishers setup is working!"
            echo "‚úÖ Provenance generation successful!"
            echo "‚úÖ Ready to publish for real."
          else
            echo "---"
            echo "‚ùå Publish dry-run failed!"
            echo ""
            echo "Possible causes:"
            echo "  1. Trusted Publisher not configured on npmjs.com"
            echo "     ‚Üí Go to: https://www.npmjs.com/package/angular-cli-ghpages/access"
            echo "     ‚Üí Add Trusted Publisher: angular-schule/angular-cli-ghpages"
            echo "  2. Workflow filename mismatch"
            echo "     ‚Üí Ensure npmjs.com has: check-npm-auth.yml"
            echo "  3. Repository/owner mismatch"
            exit 1
          fi
